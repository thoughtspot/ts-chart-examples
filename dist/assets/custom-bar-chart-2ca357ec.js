import{l as d,O as A,g as E,C,b as y}from"./number-formatting-70b2729e.js";import{a as P,g as T}from"./conditional-formatting-ba2c9fe8.js";import"./auto.esm-c3926bfe.js";import{C as v,p as V}from"./chartjs-plugin-datalabels.esm-3e57def8.js";const b={0:"color",1:"accordion.Color2",2:"accordion.datalabels"},M=["red","green","blue"];function B(t,o,l,n,a,e,s){var c,h;const u=(c=t==null?void 0:t.chartColorPalettes)!=null&&c.length&&(t==null?void 0:t.chartColorPalettes[0].colors.length)>0?t==null?void 0:t.chartColorPalettes[0].colors:d.get(o,b==null?void 0:b[l],M[l]),r=P(e,s,n,a);let i=(h=r==null?void 0:r.solidBackgroundAttrs)==null?void 0:h.color;return r!=null&&r.plotAsBand&&(i=null),i??u}function D(t,o){var a;const l=[],n=[];return(a=t==null?void 0:t.rows)==null||a.forEach(e=>{var r,i,c;const s=e!=null&&e.value?parseFloat(e.value):null,u=(r=e==null?void 0:e.solidBackgroundAttrs)==null?void 0:r.color;if((e==null?void 0:e.operator)===A.IsBetween){const h=((i=e==null?void 0:e.rangeValues)==null?void 0:i.min)??null,f=((c=e==null?void 0:e.rangeValues)==null?void 0:c.max)??null;h!==null&&f!==null&&(l.push({value:h,axisId:o,color:u,fill:e==null?void 0:e.plotAsBand},{value:f,axisId:o,color:u,fill:e==null?void 0:e.plotAsBand}),e!=null&&e.plotAsBand&&n.push({from:h,to:f,axisId:o,color:u}))}else s!==null&&l.push({value:s,axisId:o,color:u,fill:e==null?void 0:e.plotAsBand})}),{plotlines:l,plotbands:n}}function F(t){return{id:"cfPlotlinePlugin",beforeDraw(o){const l=o.ctx;t.getDatasets().forEach(n=>{const a=n.plotlines,e=n.yAxisID;a==null||a.forEach(s=>{const r=o.scales[e].getPixelForValue(s.value);l.strokeStyle=s.color||"white",l.lineWidth=1,l.beginPath(),l.moveTo(o.chartArea.left,r),l.lineTo(o.chartArea.right,r),l.stroke()})})}}}function I(t){return{id:"cfPlotbandPlugin",beforeDraw(o){const l=o.ctx,n=o.chartArea;t.getDatasets().forEach(a=>{const e=a.plotbands,s=a.yAxisID;e==null||e.forEach(u=>{const r=o.scales[s],i=r.getPixelForValue(u.from),c=r.getPixelForValue(u.to);l.fillStyle=u.color||"white",l.beginPath(),l.moveTo(n.left,i),l.lineTo(n.right,i),l.lineTo(n.right,c),l.lineTo(n.left,c),l.closePath(),l.fill()})})}}}const x=console;v.register(V);let p;const R=t=>t>1e9?(t/1e9).toFixed(2)+"B":t>1e6?(t/1e6).toFixed(2)+"M":t>1e3?(t/1e3).toFixed(2)+"K":t;function g(t,o){const l=d.findIndex(o.columns,n=>t.id===n);return d.map(o.dataValue,n=>n[l])}function $(t,o,l,n){const a=(t==null?void 0:t[0].columns)??[],e=(t==null?void 0:t[1].columns)??[];return{getLabels:()=>g(a[0],o),getDatasets:()=>d.map(e,(s,u)=>{const r=g(s,o),i=T(s),c=`${l}-y${u.toString()}`,h=r.map((L,k)=>B(null,n,u,o,i,k,s.id)),{plotlines:f,plotbands:w}=D(i,c);return{label:s.name,data:r,yAxisID:c,type:`${l}`,backgroundColor:h,borderColor:h,datalabels:{anchor:"end"},plotlines:f,plotbands:w}}),getScales:()=>d.reduce(e,(s,u,r)=>(s[`${l}-y${r.toString()}`]={grid:{display:!0},position:r===0?"left":"right",title:{display:!0,text:`${u.name}`}},s),{}),getPointDetails:(s,u)=>[{columnId:a[0].id,value:g(a[0],o)[s]},{columnId:e[u].id,value:g(e[u],o)[s]}]}}function S(t){var l,n,a;return $(((n=(l=t.config)==null?void 0:l.chartConfig)==null?void 0:n[0].dimensions)??[],((a=t.data)==null?void 0:a[0].data)??[],"bar",t.visualProps)}function Y(t){return d.pick(t.native,["clientX","clientY"])}function q(t){const o=t.getChartModel(),l=S(o),n=d.get(o.visualProps,b[2],!1);if(l)try{const a=document.getElementById("chart");a.getContext("2d").clearRect(0,0,a.width,a.height),p=new v(a,{type:"bar",data:{labels:l.getLabels(),datasets:l.getDatasets()},options:{scales:l.getScales(),animation:{duration:0},plugins:{datalabels:{display:n?"auto":!1,formatter:e=>R(e),color:"blue",textStrokeColor:"white",textStrokeWidth:5,labels:{title:{font:{weight:"bold"}},value:{color:"black"}}}},maintainAspectRatio:!1,interaction:{mode:"point",intersect:!0},onClick:e=>{const s=e.chart.getActiveElements()[0],u=s.index,r=s.datasetIndex;x.info("ChartPoint",u,r,l.getPointDetails(u,r)),t.emitEvent(C.OpenContextMenu,{event:Y(e),clickedPoint:{tuple:l.getPointDetails(u,r)}})}},plugins:[F(l),I(l)]})}catch(a){throw x.error("renderfailed",a),a}}const m=async t=>{p&&p.destroy();try{t.emitEvent(C.RenderStart),q(t)}catch(o){t.emitEvent(C.RenderError,{hasError:!0,error:o})}finally{t.emitEvent(C.RenderComplete)}};(async()=>{const t=await E({getDefaultChartConfig:o=>{const l=o.columns,n=d.filter(l,s=>s.type===y.MEASURE);return[{key:"column",dimensions:[{key:"x",columns:[d.filter(l,s=>s.type===y.ATTRIBUTE)[0]]},{key:"y",columns:n.slice(0,2)}]}]},getQueriesFromChartConfig:o=>o.map(n=>d.reduce(n.dimensions,(a,e)=>({queryColumns:[...a.queryColumns,...e.columns]}),{queryColumns:[]})),renderChart:o=>m(o),chartConfigEditorDefinition:(o,l)=>{var u,r;const{config:n,visualProps:a}=o,e=(r=(u=n==null?void 0:n.chartConfig)==null?void 0:u[0])==null?void 0:r.dimensions.find(i=>i.key==="y"&&i.columns),s=[{key:"column",label:"Custom Column",descriptionText:"X Axis can only have attributes, Y Axis can only have measures, Color can only have attributes. Should have just 1 column in Y axis with colors columns.",columnSections:[{key:"x",label:"Custom X Axis",allowAttributeColumns:!0,allowMeasureColumns:!1,allowTimeSeriesColumns:!0,maxColumnCount:1},{key:"y",label:"Custom Y Axis",allowAttributeColumns:!1,allowMeasureColumns:!0,allowTimeSeriesColumns:!1}]}];if(e!=null&&e.columns.length)for(let i=0;i<e.columns.length;i++)s[0].columnSections.push({key:`layers${i}`,label:`Measures layer${i}`,allowAttributeColumns:!1,allowMeasureColumns:!0,allowTimeSeriesColumns:!1});return s},visualPropEditorDefinition:(o,l)=>{var e,s;const{visualProps:n}=o,a=[{key:"color",type:"radio",defaultValue:"red",values:["red","green","yellow"],label:"Colors"},{type:"section",key:"accordion",label:"Accordion",children:[{key:"datalabels",type:"toggle",defaultValue:!1,label:"Data Labels"}]}];return(n==null?void 0:n.length)!==0&&(e=n==null?void 0:n.accordion)!=null&&e.datalabels&&((s=a[1].children)==null||s.push({key:"Color2",type:"radio",defaultValue:"blue",values:["blue","white","red"],label:"Color2"})),{elements:a}},validateConfig:(o,l)=>{if(o.length!==1)return{isValid:!1,validationErrorMessage:["invalid config. no config found"]};const n=o[0].dimensions;return n[0].columns.length===0||n[1].columns.length===0?{isValid:!1,validationErrorMessage:["Invalid config. X or Y axis columns cannot be empty."]}:{isValid:!0}},allowedConfigurations:{allowColumnConditionalFormatting:!0,allowColumnNumberFormatting:!0}});m(t)})();
